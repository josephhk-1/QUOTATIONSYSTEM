<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Application</title>
    
    <!-- Favicon and Meta Tags for Link Sharing -->
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <meta property="og:title" content="Quotation Application">
    <meta property="og:description" content="Generate, save, and download professional quotations in English and Arabic.">
    <meta property="og:image" content="logo.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        html[lang="ar"] body { font-family: 'Tajawal', sans-serif; }
        .no-print { }
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* Styles for the photo column and upload interaction */
        .photo-col { width: 100px; }
        .photo-upload-container {
            position: relative;
            width: 80px;
            height: 80px;
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .photo-upload-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-upload-container .placeholder-icon {
            color: #9ca3af;
        }
        .hide-photos .photo-col {
            display: none;
        }
        /* Styles to force layout during PDF rendering */
        .pdf-render-mode .grid {
            display: grid !important;
            grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        }
        .pdf-render-mode .flex.justify-between {
             display: flex !important;
             justify-content: space-between !important;
             align-items: center !important;
        }
        .pdf-render-mode [dir="rtl"] .text-right {
            text-align: right !important;
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-6 md:p-8">

    <!-- Custom Notification Area -->
    <div id="notification" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 p-4 rounded-lg shadow-lg text-white opacity-0 transform -translate-y-20 z-50 no-print">
        <span id="notification-message"></span>
    </div>

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg" id="quote-container">
        <!-- Header with Action Buttons -->
        <header class="bg-gray-800 text-white p-4 rounded-t-2xl flex flex-col md:flex-row justify-between items-center no-print gap-4">
            <div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
                <h1 class="text-lg sm:text-xl font-bold" data-lang="appTitle">Quotation Generator</h1>
                <select id="company-selector" onchange="switchCompanyProfile(this.value)" class="bg-gray-700 text-white text-sm rounded-lg p-2 border-gray-600 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                    <option value="wooden_pieces">Wooden Pieces EST.</option>
                    <option value="rattan_palace">Rattan Palace</option>
                </select>
            </div>
            <div class="flex items-center justify-center flex-wrap gap-2 w-full md:w-auto">
                <button id="toggle-photos-btn" onclick="togglePhotoColumn()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-xs md:text-sm" data-lang-show="showPhotos" data-lang-hide="hidePhotos">Hide Photos</button>
                <div class="flex space-x-1">
                    <button onclick="setLanguage('en')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-xs md:text-sm">English</button>
                    <button onclick="setLanguage('ar')" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-xs md:text-sm">العربية</button>
                </div>
                <button onclick="document.getElementById('file-loader').click()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg flex items-center text-xs md:text-sm"><span data-lang="loadSource">Load</span></button>
                <input type="file" id="file-loader" class="hidden" accept=".json" onchange="loadQuote(event)">
                <button onclick="saveQuote()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded-lg flex items-center text-xs md:text-sm"><span data-lang="saveSource">Save</span></button>
                <button onclick="generatePDF()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg flex items-center text-xs md:text-sm"><span data-lang="previewPdf">Preview PDF</span></button>
            </div>
        </header>

        <!-- Main Quotation Area -->
        <main class="p-4 md:p-10 print-area" id="print-area">
            <div class="flex justify-between items-center mb-6 gap-4">
                <div class="w-2/3">
                    <h2 class="text-3xl font-bold text-gray-800 editable" contenteditable="true" data-field="companyName" spellcheck="false"></h2>
                    <p class="text-sm text-gray-500 editable" contenteditable="true" data-field="companyCR" spellcheck="false"></p>
                    <p class="text-sm text-gray-500 editable" contenteditable="true" data-field="companyVat" spellcheck="false"></p>
                    <p class="text-sm text-gray-500 editable" contenteditable="true" data-field="companyAddress" spellcheck="false"></p>
                </div>
                <div class="w-1/3 flex justify-end">
                     <img id="company-logo" src="" alt="Company Logo" class="w-48 h-auto">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-8">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-gray-700 mb-2" data-lang="customer">Customer</h3>
                    <p class="editable" contenteditable="true" data-field="customerName" data-en="Customer Name" data-ar="اسم العميل" spellcheck="false">Customer Name</p>
                    <p class="editable" contenteditable="true" data-field="customerAddress" data-en="Customer Address" data-ar="عنوان العميل" spellcheck="false">Customer Address</p>
                    <p class="editable" contenteditable="true" data-field="customerCountry" data-en="Saudi Arabia" data-ar="المملكة العربية السعودية" spellcheck="false">Saudi Arabia</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg text-left md:text-right">
                    <p><span class="font-bold text-gray-700" data-lang="quoteNum">Quote #:</span> <span class="editable" contenteditable="true" data-field="quoteNum" spellcheck="false"></span></p>
                    <p><span class="font-bold text-gray-700" data-lang="date">Date:</span> <span id="quoteDate"></span></p>
                    <p><span class="font-bold text-gray-700" data-lang="validUntil">Valid Until:</span> <span id="validDate"></span></p>
                </div>
            </div>
            
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-2" data-lang="projectDescription">Project Description</h3>
                <p class="editable bg-gray-50 p-4 rounded-lg" contenteditable="true" data-field="projectDescription" data-en="Enter your project description here..." data-ar="أدخل وصف مشروعك هنا..." spellcheck="false">Enter your project description here...</p>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full" id="items-table">
                    <thead>
                        <tr class="bg-gray-800 text-white">
                            <th class="p-3 photo-col" data-lang="photo">Photo</th>
                            <th class="p-3 text-left" data-lang="description">Description</th>
                            <th class="p-3 w-24 text-center" data-lang="quantity">Quantity</th>
                            <th class="p-3 w-32 text-right" data-lang="unitPrice">Unit Price</th>
                            <th class="p-3 w-32 text-right" data-lang="total">Total</th>
                            <th class="p-3 w-16 text-center no-print" data-lang="action">Action</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="no-print">
                                <button id="add-row" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><span data-lang="addRow">Add Row</span></button>
                            </td>
                            <td class="text-right font-bold p-3 border-t-2" data-lang="subtotal">SUBTOTAL</td>
                            <td class="text-right p-3 border-t-2" id="subtotal">0.00</td>
                            <td class="no-print border-t-2"></td>
                        </tr>
                        <tr>
                            <td colspan="3"></td>
                            <td class="text-right font-bold p-3" data-lang="vat">VAT (15%)</td>
                            <td class="text-right p-3" id="vat">0.00</td>
                            <td class="no-print"></td>
                        </tr>
                        <tr class="bg-gray-800 text-white font-bold text-lg">
                            <td colspan="3"></td>
                            <td class="text-right p-4 rounded-l-lg" data-lang="grandTotal">TOTAL</td>
                            <td class="text-right p-4 rounded-r-lg" id="grand-total">0.00</td>
                            <td class="no-print"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-gray-700 mb-2" data-lang="terms">Terms and Conditions</h3>
                    <div class="editable text-sm" contenteditable="true" data-field="terms" data-en="<ul><li>50% Down payment</li><li>50% second payment upon delivery</li><li>Delivery within 20 to 30 days from down payment</li><li>3 years warranty on manufacturing defects</li></ul>" data-ar="<ul><li>دفعة أولى 50%</li><li>الدفعة الثانية 50% عند التسليم</li><li>التسليم في غضون 20 إلى 30 يومًا من الدفعة الأولى</li><li>ضمان 3 سنوات على عيوب التصنيع</li></ul>" spellcheck="false"><ul><li>50% Down payment</li><li>50% second payment upon delivery</li><li>Delivery within 20 to 30 days from down payment</li><li>3 years warranty on manufacturing defects</li></ul></div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-gray-700 mb-2" data-lang="bankDetails">Bank Details</h3>
                    <div class="editable text-sm" contenteditable="true" data-field="bankDetails" spellcheck="false"></div>
                </div>
            </div>

            <div class="mt-12 pt-8 border-t-2 border-dashed">
                 <div class="flex justify-between items-end">
                    <div>
                        <p class="font-bold text-gray-800" data-lang="thankYou">Thank you for your business!</p>
                    </div>
                    <div class="text-right">
                        <div class="w-48 h-12 border-b-2 border-gray-300 mb-2"></div>
                        <p class="font-bold text-gray-700" data-lang="signature">Signature</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 hidden no-print">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold" data-lang="pdfPreviewTitle">PDF Preview</h2>
                <button onclick="closePreviewModal()" class="text-gray-500 hover:text-gray-800">&times;</button>
            </header>
            <div class="p-4 overflow-auto flex-grow">
                <img id="pdf-preview-image" src="" alt="PDF Preview" class="w-full h-auto border">
            </div>
            <footer class="p-4 bg-gray-50 border-t flex justify-end gap-3">
                <button onclick="closePreviewModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" data-lang="cancel">Cancel</button>
                <button id="download-pdf-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg" data-lang="downloadPdf">Download PDF</button>
            </footer>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-sm py-4 no-print">
        Made by Joseph HAMDY KAMAL
    </footer>

    <script>
        // --- GLOBAL STATE ---
        let currentLang = 'en';
        let pdfImageData = null;
        let isPhotoColumnVisible = true;

        // --- COMPANY PROFILES DATA ---
        const companyProfiles = {
            'wooden_pieces': { 
                acronym: 'WPE', 
                logo: 'logwooden.svg', // Using the direct file path
                name: { en: 'Wooden Pieces EST.', ar: 'مؤسسة القطع الخشبية' }, 
                cr: { en: 'CR: 1010798529', ar: 'س.ت: 1010798529' }, 
                vat: { en: 'Vat No.: 310618978500003', ar: 'الرقم الضريبي: 310618978500003' }, 
                address: { en: 'RFKB2501. ALQods st, Alkhaleej, P.O.Box: 2401<br>RIYADH 13223, Kingdom of Saudi Arabia', ar: 'RFKB2501. شارع القدس, الخليج, ص.ب: 2401<br>الرياض 13223, المملكة العربية السعودية' }, 
                bankDetails: { en: `<p><strong>Bank:</strong> ALINMAA BANK</p><p><strong>IBAN:</strong> SA0705000068203914512000</p>`, ar: `<p><strong>البنك:</strong> مصرف الإنماء</p><p><strong>الآيبان:</strong> SA0705000068203914512000</p>` } 
            },
            'rattan_palace': { 
                acronym: 'RP', 
                logo: 'logo.svg', // Using the direct file path
                name: { en: 'Rattan Palace', ar: 'قصر الخيزران' }, 
                cr: { en: 'CR: 7050562888', ar: 'س.ت: 7050562888' }, 
                vat: { en: 'Vat No.: 313099850500003', ar: 'الرقم الضريبي: 313099850500003' }, 
                address: { en: 'RFKB2501. ALQods st, Alkhaleej, P.O.Box: 2401<br>RIYADH 13223, Kingdom of Saudi Arabia', ar: 'RFKB2501. شارع القدس, الخليج, ص.ب: 2401<br>الرياض 13223, المملكة العربية السعودية' }, 
                bankDetails: { en: `<p><strong>Bank:</strong> Riyad Bank</p><p><strong>IBAN:</strong> SA3020000002126072249940</p>`, ar: `<p><strong>البنك:</strong> بنك الرياض</p><p><strong>الآيبان:</strong> SA3020000002126072249940</p>` } 
            }
        };

        // --- TRANSLATION DATA ---
        const translations = {
            en: { appTitle: "Quotation Generator", loadSource: "Load", saveSource: "Save", previewPdf: "Preview PDF", downloadPdf: "Download PDF", customer: "Customer", quoteNum: "Quote #:", date: "Date:", validUntil: "Valid Until:", projectDescription: "Project Description", photo: "Photo", description: "Description", quantity: "Quantity", unitPrice: "Unit Price", total: "Total", action: "Action", addRow: "Add Row", subtotal: "SUBTOTAL", vat: "VAT (15%)", grandTotal: "TOTAL", terms: "Terms and Conditions", bankDetails: "Bank Details", thankYou: "Thank you for your business!", signature: "Signature", pdfPreviewTitle: "PDF Preview", cancel: "Cancel", fileLoadError: "Error: Could not load the quote file. It may be corrupted.", showPhotos: "Show Photos", hidePhotos: "Hide Photos" },
            ar: { appTitle: "مولد عروض الأسعار", loadSource: "تحميل", saveSource: "حفظ", previewPdf: "معاينة PDF", downloadPdf: "تحميل PDF", customer: "العميل", quoteNum: "رقم عرض السعر:", date: "التاريخ:", validUntil: "صالح حتى:", projectDescription: "وصف المشروع", photo: "صورة", description: "الوصف", quantity: "الكمية", unitPrice: "سعر الوحدة", total: "المجموع", action: "إجراء", addRow: "أضف سطراً", subtotal: "المجموع الفرعي", vat: "ضريبة القيمة المضافة (15%)", grandTotal: "المجموع الإجمالي", terms: "الشروط والأحكام", bankDetails: "التفاصيل البنكية", thankYou: "شكرا لعملك معنا!", signature: "التوقيع", pdfPreviewTitle: "معاينة PDF", cancel: "إلغاء", fileLoadError: "خطأ: لا يمكن تحميل ملف عرض السعر. قد يكون تالفًا.", showPhotos: "إظهار الصور", hidePhotos: "إخفاء الصور" }
        };

        // --- UI FUNCTIONS ---
        function showNotification(messageKey, isError = false) {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notification-message');
            messageEl.textContent = translations[currentLang][messageKey] || messageKey;
            notification.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 p-4 rounded-lg shadow-lg text-white opacity-0 transform -translate-y-20 z-50 no-print ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            setTimeout(() => { notification.classList.remove('opacity-0', '-translate-y-20'); notification.classList.add('opacity-100', 'translate-y-0'); }, 10);
            setTimeout(() => { notification.classList.remove('opacity-100', 'translate-y-0'); notification.classList.add('opacity-0', '-translate-y-20'); }, 3000);
        }

        function togglePhotoColumn() {
            isPhotoColumnVisible = !isPhotoColumnVisible;
            const table = document.getElementById('items-table');
            const btn = document.getElementById('toggle-photos-btn');
            if (isPhotoColumnVisible) {
                table.classList.remove('hide-photos');
                btn.textContent = translations[currentLang].hidePhotos;
            } else {
                table.classList.add('hide-photos');
                btn.textContent = translations[currentLang].showPhotos;
            }
        }
        
        function generateQuoteNumber(profileKey) {
            const profile = companyProfiles[profileKey];
            if (!profile) return;
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = String(now.getFullYear()).slice(-2);
            const dateStr = `${day}${month}${year}`;
            const quoteNumber = `Q${profile.acronym}${dateStr}`;
            const quoteNumEl = document.querySelector('[data-field="quoteNum"]');
            quoteNumEl.dataset.en = quoteNumber;
            quoteNumEl.dataset.ar = quoteNumber;
            quoteNumEl.textContent = quoteNumber;
        }

        function switchCompanyProfile(profileKey) {
            const profile = companyProfiles[profileKey];
            if (!profile) return;
            document.getElementById('company-logo').src = profile.logo;
            document.querySelector('[data-field="companyName"]').dataset.en = profile.name.en;
            document.querySelector('[data-field="companyName"]').dataset.ar = profile.name.ar;
            document.querySelector('[data-field="companyCR"]').dataset.en = profile.cr.en;
            document.querySelector('[data-field="companyCR"]').dataset.ar = profile.cr.ar;
            document.querySelector('[data-field="companyVat"]').dataset.en = profile.vat.en;
            document.querySelector('[data-field="companyVat"]').dataset.ar = profile.vat.ar;
            document.querySelector('[data-field="companyAddress"]').dataset.en = profile.address.en;
            document.querySelector('[data-field="companyAddress"]').dataset.ar = profile.address.ar;
            document.querySelector('[data-field="bankDetails"]').dataset.en = profile.bankDetails.en;
            document.querySelector('[data-field="bankDetails"]').dataset.ar = profile.bankDetails.ar;
            generateQuoteNumber(profileKey);
            setLanguage(currentLang, true);
        }

        function setLanguage(lang, isProfileSwitch = false) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            const toggleBtn = document.getElementById('toggle-photos-btn');
            toggleBtn.textContent = isPhotoColumnVisible ? translations[lang].hidePhotos : translations[lang].showPhotos;
            document.querySelectorAll('.editable').forEach(el => {
                 el.innerHTML = el.dataset[lang] || '';
            });
            document.querySelectorAll('.item-description').forEach(el => {
                el.innerHTML = el.dataset[lang] || '';
            });
        }

        function updateEditableData(element) {
            element.dataset[currentLang] = element.innerHTML;
        }
        
        function syncUIData() {
            document.querySelectorAll('.editable, .item-description').forEach(el => updateEditableData(el));
        }

        function updateTotals() {
            let subtotal = 0;
            document.querySelectorAll('#table-body tr').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
                const total = quantity * unitPrice;
                row.querySelector('.total').textContent = total.toFixed(2);
                subtotal += total;
            });
            const vat = subtotal * 0.15;
            const grandTotal = subtotal + vat;
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('vat').textContent = vat.toFixed(2);
            document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        }

        function addNewRow(item = { photo: '', desc_en: 'New Item', desc_ar: 'عنصر جديد', qty: 1, price: 0.00 }) {
            const tableBody = document.getElementById('table-body');
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200';
            
            row.innerHTML = `
                <td class="p-3 photo-col">
                    <div class="photo-upload-container">
                        <img src="${item.photo || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" class="${item.photo ? '' : 'hidden'}" data-photo-base64="${item.photo || ''}">
                        <div class="placeholder-icon ${item.photo ? 'hidden' : ''}">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <input type="file" class="hidden" accept="image/*">
                    </div>
                </td>
                <td class="p-3">
                    <div class="w-full bg-gray-50 rounded p-2 item-description editable" contenteditable="true" data-en="${item.desc_en}" data-ar="${item.desc_ar}" spellcheck="false"></div>
                </td>
                <td class="p-3"><input type="number" value="${item.qty}" min="0" class="quantity w-full text-center bg-gray-50 rounded p-2"></td>
                <td class="p-3"><input type="number" value="${item.price}" step="0.01" min="0" class="unit-price w-full text-right bg-gray-50 rounded p-2"></td>
                <td class="p-3 text-right total">0.00</td>
                <td class="p-3 text-center no-print">
                    <button class="remove-row text-red-500 hover:text-red-700"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </td>
            `;
            tableBody.appendChild(row);
            
            const descDiv = row.querySelector('.item-description');
            descDiv.innerHTML = descDiv.dataset[currentLang];
            descDiv.addEventListener('input', () => updateEditableData(descDiv));
            row.querySelector('.quantity').addEventListener('input', updateTotals);
            row.querySelector('.unit-price').addEventListener('input', updateTotals);
            row.querySelector('.remove-row').addEventListener('click', () => { row.remove(); updateTotals(); });

            const photoContainer = row.querySelector('.photo-upload-container');
            const fileInput = row.querySelector('input[type="file"]');
            const imgEl = row.querySelector('img');
            const placeholder = row.querySelector('.placeholder-icon');

            photoContainer.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imgEl.src = e.target.result;
                        imgEl.dataset.photoBase64 = e.target.result;
                        imgEl.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            updateTotals();
        }

        // --- FILE & PDF OPERATIONS ---
        function saveQuote() {
            syncUIData();
            const customerName = document.querySelector('[data-field="customerName"]').textContent.trim();
            const sanitizedName = customerName.replace(/[^a-z0-9\u0600-\u06FF]/gi, '_');
            const quoteData = { lang: currentLang, companyProfile: document.getElementById('company-selector').value, fields: {}, items: [] };

            document.querySelectorAll('.editable').forEach(el => {
                const fieldName = el.dataset.field;
                if (fieldName) quoteData.fields[fieldName] = { en: el.dataset.en || '', ar: el.dataset.ar || '' };
            });

            document.querySelectorAll('#table-body tr').forEach(row => {
                const descEl = row.querySelector('.item-description');
                const imgEl = row.querySelector('img');
                quoteData.items.push({
                    photo: imgEl.dataset.photoBase64 || '',
                    desc_en: descEl.dataset.en,
                    desc_ar: descEl.dataset.ar,
                    qty: row.querySelector('.quantity').value,
                    price: row.querySelector('.unit-price').value
                });
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(quoteData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `Source_${sanitizedName || 'quotation'}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadQuote(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.companyProfile) document.getElementById('company-selector').value = data.companyProfile;
                    Object.keys(data.fields).forEach(fieldName => {
                        const el = document.querySelector(`.editable[data-field="${fieldName}"]`);
                        if (el) {
                            el.dataset.en = data.fields[fieldName].en;
                            el.dataset.ar = data.fields[fieldName].ar;
                        }
                    });
                    switchCompanyProfile(data.companyProfile || 'wooden_pieces');
                    document.getElementById('table-body').innerHTML = '';
                    data.items.forEach(item => addNewRow(item));
                    setLanguage(data.lang || 'en');
                    updateTotals();
                } catch (error) {
                    console.error("Failed to parse JSON file:", error);
                    showNotification('fileLoadError', true);
                }
            };
            reader.readAsText(event.target.files[0]);
            event.target.value = '';
        }

        function closePreviewModal() {
            document.getElementById('pdf-preview-modal').classList.add('hidden');
            pdfImageData = null;
        }

        async function generatePDF() {
            syncUIData();
            if (document.activeElement) document.activeElement.blur();
            const { jsPDF } = window.jspdf;
            const quoteElement = document.getElementById('print-area');
            const printableClone = quoteElement.cloneNode(true);
            
            // Force LTR direction for consistent block layout in PDF
            printableClone.dir = 'ltr';
            
            // Add a class to the clone to apply PDF-specific styles
            printableClone.classList.add('pdf-render-mode');
            
            printableClone.style.width = '1024px'; 
            printableClone.style.position = 'absolute';
            printableClone.style.left = '-9999px';
            printableClone.style.top = '0';
            document.body.appendChild(printableClone);

            printableClone.querySelectorAll('input.quantity, input.unit-price').forEach(input => {
                const span = document.createElement('span');
                span.textContent = input.value;
                if (input.classList.contains('text-center')) span.classList.add('text-center');
                if (input.classList.contains('text-right')) span.classList.add('text-right');
                span.classList.add('w-full', 'block', 'p-2');
                input.parentNode.replaceChild(span, input);
            });
            
            printableClone.querySelectorAll('.bg-gray-50').forEach(el => {
                el.classList.remove('bg-gray-50');
                el.style.backgroundColor = 'transparent';
            });
            printableClone.querySelectorAll('.no-print').forEach(el => el.remove());
            
            // The Base64 logos load instantly, so no need to wait for them.
            // We just give a minimal timeout for the browser to apply styles.
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                const canvas = await html2canvas(printableClone, { scale: 3, useCORS: true, logging: false });
                pdfImageData = canvas.toDataURL('image/png');
                document.getElementById('pdf-preview-image').src = pdfImageData;
                document.getElementById('pdf-preview-modal').classList.remove('hidden');

                document.getElementById('download-pdf-btn').onclick = () => {
                    const customerName = document.querySelector('[data-field="customerName"]').textContent.trim();
                    const sanitizedName = customerName.replace(/\[.*?\]/g, '').replace(/[^a-z0-9\u0600-\u06FF]/gi, '_').replace(/^_|_$/g, '');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(pdfImageData);
                    const imgRatio = imgProps.width / imgProps.height;
                    let imgWidth = pdfWidth - 20;
                    let imgHeight = imgWidth / imgRatio;
                    if (imgHeight > pdfHeight - 20) {
                        imgHeight = pdfHeight - 20;
                        imgWidth = imgHeight * imgRatio;
                    }
                    const x = (pdfWidth - imgWidth) / 2;
                    const y = 10;
                    pdf.addImage(pdfImageData, 'PNG', x, y, imgWidth, imgHeight);
                    pdf.save(`Quotation_${sanitizedName || 'details'}.pdf`);
                    closePreviewModal();
                };
            } catch (error) {
                console.error("Error generating PDF canvas:", error);
                showNotification("Error generating PDF preview.", true);
            } finally {
                document.body.removeChild(printableClone);
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            document.getElementById('quoteDate').textContent = today.toLocaleDateString('en-CA');
            const validUntil = new Date();
            validUntil.setDate(today.getDate() + 7);
            document.getElementById('validDate').textContent = validUntil.toLocaleDateString('en-CA');
            document.querySelectorAll('.editable').forEach(el => {
                el.addEventListener('input', () => updateEditableData(el));
            });
            document.getElementById('add-row').addEventListener('click', () => addNewRow());
            switchCompanyProfile('wooden_pieces');
            addNewRow();
            updateTotals();
        });
    </script>
</body>
</html>
