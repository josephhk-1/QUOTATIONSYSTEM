<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Quotation Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .quotation-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .header-controls {
            max-width: 800px;
            margin: 1rem auto;
            padding: 1rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .quotation-container, .quotation-container * {
                visibility: visible;
            }
            .quotation-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            .no-print {
                display: none;
            }
        }
        .rtl {
            direction: rtl;
        }
        .ltr {
            direction: ltr;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="header-controls no-print">
        <h1 class="text-xl font-bold text-gray-800">Quotation Generator</h1>
        <div class="flex items-center space-x-2">
            <select id="companySelector" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                <option value="rattan">Rattan Palace (قصر الخيزران)</option>
                <option value="wooden">Wooden Pieces EST.</option>
            </select>
            <button id="langBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                العربية
            </button>
            <button id="saveBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                Save
            </button>
            <button id="loadBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                Load
            </button>
            <button id="pdfBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                PDF
            </button>
        </div>
    </div>

    <div id="quotation" class="quotation-container">
        <!-- Company Info -->
        <div id="companyInfo" class="flex justify-between items-start mb-4">
            <div class="flex items-center">
                <img id="companyLogo" src="logo.svg" alt="Company Logo" class="h-20 mr-4">
                <div>
                    <h2 id="companyName" class="text-2xl font-bold">Rattan Palace</h2>
                    <p id="companyNameAr" class="text-xl">قصر الخيزران</p>
                    <div id="companyDetails" class="text-sm text-gray-600 mt-1">
                        <p>VAT No: 313099850500003</p>
                        <p>CR/License: 7050562888</p>
                        <p>RFKB2501. AlQods st, Alkhaleej, P.O.Box: 2401</p>
                        <p>RIYADH 13223, Kingdom of Saudi Arabia</p>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <h1 class="text-4xl font-bold text-gray-800" data-en="QUOTATION" data-ar="عرض سعر">QUOTATION</h1>
                <div class="mt-2">
                    <p><strong data-en="Quote #:" data-ar=":رقم العرض">Quote #:</strong> <span contenteditable="true">S963</span></p>
                    <p><strong data-en="Date:" data-ar=":التاريخ">Date:</strong> <span contenteditable="true" id="quoteDate">2025-08-26</span></p>
                    <p><strong data-en="Valid Until:" data-ar=":صالح حتى">Valid Until:</strong> <span contenteditable="true" id="validDate">2025-09-02</span></p>
                </div>
            </div>
        </div>

        <!-- Customer Info & Project Description -->
        <div class="grid grid-cols-2 gap-8 mb-6">
            <div class="bg-gray-100 p-4 rounded-lg">
                 <h3 class="font-bold mb-2" data-en="Customer" data-ar="العميل">Customer</h3>
                 <p contenteditable="true" id="customerName">Customer Name</p>
                 <p contenteditable="true" id="customerAddress">Customer Address</p>
                 <p contenteditable="true" id="customerCountry">Saudi Arabia</p>
            </div>
             <div>
                <h3 class="font-bold mb-2" data-en="Project Description" data-ar="وصف المشروع">Project Description</h3>
                <p contenteditable="true" id="projectDescription">Enter your project description here...</p>
            </div>
        </div>


        <!-- Items Table -->
        <table class="w-full mb-8">
            <thead>
                <tr class="bg-gray-800 text-white">
                    <th class="p-2 text-left" data-en="Description" data-ar="الوصف">Description</th>
                    <th class="p-2 text-center w-24" data-en="Quantity" data-ar="الكمية">Quantity</th>
                    <th class="p-2 text-right w-32" data-en="Unit Price" data-ar="سعر الوحدة">Unit Price</th>
                    <th class="p-2 text-right w-32" data-en="Total" data-ar="المجموع">Total</th>
                    <th class="p-2 text-center w-16 no-print" data-en="Action" data-ar="إجراء">Action</th>
                </tr>
            </thead>
            <tbody id="itemRows">
                <!-- Rows will be added here dynamically -->
            </tbody>
        </table>
        <button id="addRowBtn" class="no-print bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-4" data-en="Add Row" data-ar="أضف صف">Add Row</button>

        <!-- Totals -->
        <div class="flex justify-end mb-8">
            <div class="w-64">
                <div class="flex justify-between">
                    <span class="font-bold" data-en="SUBTOTAL" data-ar="المجموع الفرعي">SUBTOTAL</span>
                    <span id="subtotal">0.00</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold" data-en="VAT (15%)" data-ar="ضريبة القيمة المضافة (15%)">VAT (15%)</span>
                    <span id="vat">0.00</span>
                </div>
                <div class="flex justify-between font-bold text-xl mt-2 pt-2 border-t-2 border-gray-800">
                    <span data-en="TOTAL" data-ar="المجموع الإجمالي">TOTAL</span>
                    <span id="total">0.00</span>
                </div>
            </div>
        </div>

        <!-- Terms and Bank Details -->
        <div class="grid grid-cols-2 gap-8 mb-8">
            <div id="terms" class="bg-gray-100 p-4 rounded-lg">
                <h4 class="font-bold mb-2" data-en="Terms and Conditions" data-ar="الشروط والأحكام">Terms and Conditions</h4>
                <div contenteditable="true">
                    <p>50% Down payment upon order confirmation</p>
                    <p>30% second payment upon delivery</p>
                    <p>20% third payment upon completion</p>
                    <p>Delivery within 20 to 30 days from down payment</p>
                    <p>3 years warranty on manufacturing defects</p>
                </div>
            </div>
            <div id="bankDetails" class="bg-gray-100 p-4 rounded-lg">
                 <h4 class="font-bold mb-2" data-en="Bank Details" data-ar="تفاصيل البنك">Bank Details</h4>
                 <div contenteditable="true">
                    <p><strong>Bank:</strong> <span id="bankName">Riyad Bank</span></p>
                    <p><strong>IBAN:</strong> <span id="iban">SA3020000002126072249940</span></p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-600 mt-8 pt-4 border-t">
            <p data-en="Thank you for your business!" data-ar="شكرا لتعاملكم معنا!">Thank you for your business!</p>
        </div>
        <div class="flex justify-end mt-16">
            <div class="w-64 text-center">
                <div class="border-t-2 border-gray-400 pt-2">
                    <p data-en="Signature" data-ar="التوقيع">Signature</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-sm mt-4 pb-4 no-print">
        Made by Joseph HAMDY KAMAL
    </footer>

    <script>
        // --- DATA ---
        const companyData = {
            rattan: {
                name: "Rattan Palace",
                nameAr: "قصر الخيزران",
                logo: "logo.svg",
                details: [
                    "VAT No: 313099850500003",
                    "CR/License: 7050562888",
                    "RFKB2501. AlQods st, Alkhaleej, P.O.Box: 2401",
                    "RIYADH 13223, Kingdom of Saudi Arabia"
                ],
                bank: "Riyad Bank",
                iban: "SA3020000002126072249940"
            },
            wooden: {
                name: "Wooden Pieces EST.",
                nameAr: "مؤسسة القطع الخشبية للتجارة",
                logo: "logwooden.svg",
                details: [
                    "CR: 1010798529",
                    "Vat No.: 310618978500003",
                    "Short Address: RFKB2501. ALQods st, Alkhaleej, P.O.Box: 2401",
                    "RIYADH 13223, Kingdom of Saudi Arabia"
                ],
                bank: "ALINMAA BANK",
                iban: "SA0705000068203914512000"
            }
        };

        let currentLang = 'en';

        // --- ELEMENTS ---
        const companySelector = document.getElementById('companySelector');
        const companyLogo = document.getElementById('companyLogo');
        const companyName = document.getElementById('companyName');
        const companyNameAr = document.getElementById('companyNameAr');
        const companyDetails = document.getElementById('companyDetails');
        const bankName = document.getElementById('bankName');
        const iban = document.getElementById('iban');
        const itemRows = document.getElementById('itemRows');
        const addRowBtn = document.getElementById('addRowBtn');
        const subtotalEl = document.getElementById('subtotal');
        const vatEl = document.getElementById('vat');
        const totalEl = document.getElementById('total');
        const pdfBtn = document.getElementById('pdfBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const langBtn = document.getElementById('langBtn');
        const quotationContainer = document.getElementById('quotation');

        // --- FUNCTIONS ---

        /**
         * Updates company information based on selection.
         */
        function updateCompanyInfo() {
            const selectedCompany = companyData[companySelector.value];
            companyLogo.src = selectedCompany.logo;
            companyLogo.onerror = () => { companyLogo.src = 'https://placehold.co/100x100/ccc/fff?text=Logo'; };
            companyName.textContent = selectedCompany.name;
            companyNameAr.textContent = selectedCompany.nameAr;
            companyDetails.innerHTML = selectedCompany.details.map(d => `<p>${d}</p>`).join('');
            bankName.textContent = selectedCompany.bank;
            iban.textContent = selectedCompany.iban;
        }

        /**
         * Adds a new item row to the table.
         */
        function addRow() {
            const row = document.createElement('tr');
            row.className = 'border-b';
            row.innerHTML = `
                <td class="p-2"><div contenteditable="true">New Item</div></td>
                <td class="p-2 text-center"><div contenteditable="true">1</div></td>
                <td class="p-2 text-right"><div contenteditable="true">0.00</div></td>
                <td class="p-2 text-right">0.00</td>
                <td class="p-2 text-center no-print">
                    <button class="text-red-500 hover:text-red-700 delete-row">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `;
            itemRows.appendChild(row);
            row.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.addEventListener('input', calculateTotals);
            });
            row.querySelector('.delete-row').addEventListener('click', () => {
                row.remove();
                calculateTotals();
            });
            calculateTotals();
        }

        /**
         * Calculates all totals.
         */
        function calculateTotals() {
            let subtotal = 0;
            itemRows.querySelectorAll('tr').forEach(row => {
                const quantity = parseFloat(row.children[1].textContent) || 0;
                const unitPrice = parseFloat(row.children[2].textContent.replace(/,/g, '')) || 0;
                const total = quantity * unitPrice;
                row.children[3].textContent = total.toFixed(2);
                subtotal += total;
            });

            const vat = subtotal * 0.15;
            const total = subtotal + vat;

            subtotalEl.textContent = subtotal.toFixed(2);
            vatEl.textContent = vat.toFixed(2);
            totalEl.textContent = total.toFixed(2);
        }

        /**
         * Generates and downloads a PDF of the quotation.
         */
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const quoteElement = document.getElementById('quotation');
            const originalWidth = quoteElement.style.width;
            quoteElement.style.width = '800px'; // Set a fixed width for consistent PDF output

            html2canvas(quoteElement, {
                scale: 2, // Higher scale for better quality
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`quotation-${Date.now()}.pdf`);
                quoteElement.style.width = originalWidth; // Reset width
            }).catch(err => {
                console.error("Error generating PDF:", err);
                quoteElement.style.width = originalWidth; // Reset width on error
            });
        }
        
        /**
         * Saves the current quotation data to a JSON file.
         */
        function saveData() {
            const data = {
                company: companySelector.value,
                quoteNumber: document.querySelector('[aria-label="Quote Number"]').textContent,
                quoteDate: document.getElementById('quoteDate').textContent,
                validDate: document.getElementById('validDate').textContent,
                customerName: document.getElementById('customerName').textContent,
                customerAddress: document.getElementById('customerAddress').textContent,
                customerCountry: document.getElementById('customerCountry').textContent,
                projectDescription: document.getElementById('projectDescription').textContent,
                items: [],
                terms: document.querySelector('#terms [contenteditable="true"]').innerHTML,
                bankDetails: document.querySelector('#bankDetails [contenteditable="true"]').innerHTML,
            };

            itemRows.querySelectorAll('tr').forEach(row => {
                data.items.push({
                    description: row.children[0].textContent,
                    quantity: row.children[1].textContent,
                    unitPrice: row.children[2].textContent,
                });
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "quotation-data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        /**
         * Loads quotation data from a file.
         */
        function loadData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.readAsText(file, 'UTF-8');
                reader.onload = readerEvent => {
                    const content = readerEvent.target.result;
                    try {
                        const data = JSON.parse(content);
                        populateForm(data);
                    } catch (err) {
                        console.error("Error parsing JSON file:", err);
                        alert("Invalid data file.");
                    }
                }
            }
            input.click();
        }

        /**
         * Populates the form with loaded data.
         */
        function populateForm(data) {
            companySelector.value = data.company;
            updateCompanyInfo();

            document.querySelector('[aria-label="Quote Number"]').textContent = data.quoteNumber;
            document.getElementById('quoteDate').textContent = data.quoteDate;
            document.getElementById('validDate').textContent = data.validDate;
            document.getElementById('customerName').textContent = data.customerName;
            document.getElementById('customerAddress').textContent = data.customerAddress;
            document.getElementById('customerCountry').textContent = data.customerCountry;
            document.getElementById('projectDescription').textContent = data.projectDescription;
            document.querySelector('#terms [contenteditable="true"]').innerHTML = data.terms;
            document.querySelector('#bankDetails [contenteditable="true"]').innerHTML = data.bankDetails;
            
            itemRows.innerHTML = '';
            data.items.forEach(item => {
                addRow();
                const newRow = itemRows.lastChild;
                newRow.children[0].textContent = item.description;
                newRow.children[1].textContent = item.quantity;
                newRow.children[2].textContent = item.unitPrice;
            });
            calculateTotals();
        }

        /**
         * Toggles language between English and Arabic.
         */
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            langBtn.textContent = currentLang === 'en' ? 'العربية' : 'English';
            
            quotationContainer.classList.toggle('rtl', currentLang === 'ar');
            quotationContainer.classList.toggle('ltr', currentLang === 'en');
            
            document.querySelectorAll('[data-en]').forEach(el => {
                el.textContent = el.dataset[currentLang];
            });
        }

        /**
         * Sets initial dates.
         */
        function setInitialDates() {
            const today = new Date();
            const validUntil = new Date();
            validUntil.setDate(today.getDate() + 7);
            
            const formatDate = (date) => {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            document.getElementById('quoteDate').textContent = formatDate(today);
            document.getElementById('validDate').textContent = formatDate(validUntil);
        }

        // --- EVENT LISTENERS ---
        companySelector.addEventListener('change', updateCompanyInfo);
        addRowBtn.addEventListener('click', addRow);
        pdfBtn.addEventListener('click', generatePDF);
        saveBtn.addEventListener('click', saveData);
        loadBtn.addEventListener('click', loadData);
        langBtn.addEventListener('click', toggleLanguage);
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            updateCompanyInfo();
            setInitialDates();
            addRow(); // Start with one row
        });

    </script>
</body>
</html>
